<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Convertidor de Documentos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container space-y-6">
        <h1 class="text-3xl font-bold text-gray-800">Convierte tus documentos</h1>
        <p class="text-gray-600">Sube tu archivo HTML y CSS.</p>

        <!-- Contenedor para el estado de los archivos -->
        <div id="estado-archivos" class="flex flex-col items-start w-full p-4 border rounded-lg bg-gray-50 border-gray-200 text-left">
            <div id="estado-html" class="flex items-center space-x-2 text-red-500 font-semibold">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span>Archivo HTML: No subido</span>
            </div>
            <div id="estado-css" class="flex items-center space-x-2 text-red-500 font-semibold mt-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                </svg>
                <span>Archivo CSS: No subido</span>
            </div>
        </div>

        <!-- Inputs de archivo ocultos -->
        <input type="file" id="input-html" class="hidden" accept=".html">
        <input type="file" id="input-css" class="hidden" accept=".css">
        
        <!-- Botones de acción -->
        <div class="space-y-4">
            <button id="boton-subir-html" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Subir archivo HTML
            </button>
            <button id="boton-subir-css" class="w-full px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                Subir archivo CSS
            </button>
            <button id="boton-procesar" class="w-full px-6 py-3 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors" disabled>
                Procesar y convertir
            </button>
            <button id="boton-descargar" class="w-full px-6 py-3 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 transition-colors hidden">
                Descargar resultado
            </button>
            <button id="boton-reiniciar" class="w-full px-6 py-3 bg-gray-400 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-500 transition-colors hidden">
                Reiniciar
            </button>
        </div>
    </div>

    <script>
        // Variables de estado
        let htmlFile = null;
        let cssFile = null;
        let archivoProcesado = null;
        let nombreArchivoProcesado = null;
        let tipoMimeProcesado = null;

        // Elementos del DOM
        const inputHtml = document.getElementById('input-html');
        const inputCss = document.getElementById('input-css');
        const botonSubirHtml = document.getElementById('boton-subir-html');
        const botonSubirCss = document.getElementById('boton-subir-css');
        const botonProcesar = document.getElementById('boton-procesar');
        const botonDescargar = document.getElementById('boton-descargar');
        const botonReiniciar = document.getElementById('boton-reiniciar');
        const estadoHtml = document.getElementById('estado-html');
        const estadoCss = document.getElementById('estado-css');

        function actualizarEstadoUI() {
            // Actualiza el estado visual de los archivos subidos
            if (htmlFile) {
                estadoHtml.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>Archivo HTML: ${htmlFile.name}</span>`;
                estadoHtml.classList.remove('text-red-500');
                estadoHtml.classList.add('text-green-500');
            } else {
                estadoHtml.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg><span>Archivo HTML: No subido</span>`;
                estadoHtml.classList.add('text-red-500');
                estadoHtml.classList.remove('text-green-500');
            }

            if (cssFile) {
                estadoCss.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span>Archivo CSS: ${cssFile.name}</span>`;
                estadoCss.classList.remove('text-red-500');
                estadoCss.classList.add('text-green-500');
            } else {
                estadoCss.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg><span>Archivo CSS: No subido</span>`;
                estadoCss.classList.add('text-red-500');
                estadoCss.classList.remove('text-green-500');
            }

            // Habilita el botón de procesar si ambos archivos están subidos
            if (htmlFile && cssFile) {
                botonProcesar.disabled = false;
            } else {
                botonProcesar.disabled = true;
            }

            // Muestra el botón de reiniciar si al menos un archivo está subido
            if (htmlFile || cssFile) {
                botonReiniciar.classList.remove('hidden');
            } else {
                botonReiniciar.classList.add('hidden');
            }
        }

        // Función para procesar los archivos
        function procesarArchivos(htmlFile, cssFile) {
            botonProcesar.disabled = true;
            botonProcesar.textContent = 'Procesando...';
            botonDescargar.classList.add('hidden');
            botonSubirHtml.disabled = true;
            botonSubirCss.disabled = true;

            const leerHTML = new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(htmlFile);
            });

            const leerCSS = new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e);
                reader.readAsText(cssFile);
            });

            Promise.all([leerHTML, leerCSS])
                .then(([htmlContenido, cssContenido]) => {
                    // --- Lógica de conversión ---
                    try {
                        cssContenido = cssContenido.replace(/(ORCID)|(orcid)/gi, 'ORCID2');
                        const tipoRevistaMatch = htmlContenido.match(/class="como_citar">.*?class="cursivas">\s*([^<\s]+)/s);
                        const revista = tipoRevistaMatch ? tipoRevistaMatch[1].toLowerCase() : '';
                        const revistaCompletaMatch = htmlContenido.match(/class="como_citar">\s*<p class="cursivas">\s*([^<]+)/s);
                        const revistaCompleta = revistaCompletaMatch ? revistaCompletaMatch[1].trim() : '';
                        if (revistaCompletaMatch) {
                            revistaCompleta = revistaCompletaMatch[1];
                            revistaCompleta = revistaCompleta.replace(/<[^>]*>/g, '').trim();
                        }
                        
                        console.log(`'${revista}'`);
                        console.log(`'${revistaCompleta}'`)

                        let ubicacionOrcidMatch;
                        let ubicacionTexto;
                        let nuevoHtml = htmlContenido;
                        nuevoHtml = nuevoHtml.replace(/<span class="no-separar">(.*?)<\/span>/g,'$1');
                        nuevoHtml = nuevoHtml.replace(/&#160;/g,' ');
                        const tiporevista = /https:\/\/orcid\.org\/\d{4}-\d{4}-\d{4}-\d{4}/g;
                        if (revista.includes('problema')) {
                            const ubicacionOrcidMatch = cssContenido.match(/\.([^}]*AUT[^}]*)\{\s*[^}]*?text-align\s*:\s*(\w+)\s*;/i);
                            const valorEncontrado = ubicacionOrcidMatch?.[2];
                            if (!valorEncontrado || valorEncontrado === '-') {
                                ubicacionTexto = 'flex-end';
                            } else {
                                // Si se encontró un valor válido, lo usamos
                                ubicacionTexto = valorEncontrado;
                            }
                        } else if(revistaCompleta.includes('Revista Mexicana de Derecho Constitucional')){
                            ubicacionTexto = `center`;
                        }else if(revistaCompleta.includes('Estudios en derecho a la información')){
                            ubicacionTexto = `center`;
                        }
                        else {
                            ubicacionTexto = `flex-end`;
                        }

                        const orcidRegex = /https:\/\/orcid\.org\/\d{4}-\d{4}-\d{4}-\d{4}/g;
                        const linkOrcid = [...new Set(htmlContenido.match(orcidRegex) || [])];
const estilosDatosAutor = `
/* Estilos para agrupar datos de autor sin márgenes internos */
.ORCID2 {
    margin-bottom: 0.2em !important; /* Reduce espacio después del ORCID */
    margin-top: 1.5em !important;    /* Asegura espacio entre diferentes autores (orcid a orcid) */
}

/* Anula los márgenes de los párrafos de afiliación/email que siguen al ORCID */
.ORCID2 + p,
.ORCID2 + p + p {
    margin-top: 0 !important;
    margin-bottom: 0 !important;
    line-height: 1.4; /* Mejora la legibilidad al estar juntos */
}

/* Identifica el último párrafo de datos de autor antes del DOI */
p:has(+ p.ESTILOS-FINALES_DOI) {
    margin-bottom: 2em !important; /* Añade espacio entre los datos y el DOI */
}
`;
                        const clasesVector = `
.ORCID2 {
    display: flex;
    justify-content: ${ubicacionTexto};
    align-items: center;
    gap: 0.5em; 
}
.ORCID2 ._idSVGInline {
    display: inline-block;
    width: 1em;
    height: 1em;
}
.ORCID2 svg {
    width: 80%;
    height: 80%;
    display: block;
}
.ORCID2 a {
    text-decoration: none;
    color: inherit;
    font-size: 1em;
}`;

                        const svgContent = `
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
    viewBox="0 0 256 256" xml:space="preserve">
    <style type="text/css">
        .st0 { fill: #A6CE39; }
        .st1 { fill: #FFFFFF; }
    </style>
    <circle class="st0" cx="128" cy="128" r="128" />
    <g>
        <path class="st1" d="M86.3,186.2H70.9V79.1h15.4v48.4V186.2z" />
        <path class="st1" d="M108.9,79.1h41.6c39.6,0,57,28.3,57,53.6c0,27.5-21.5,53.6-56.8,53.6h-41.8V79.1z
            M124.3,172.4h24.5c34.9,0,42.9-26.5,42.9-39.7c0-21.5-13.7-39.7-43.7-39.7h-23.7V172.4z" />
        <path class="st1" d="M88.7,56.8c0,5.5-4.5,10.1-10.1,10.1c-5.6,0-10.1-4.6-10.1-10.1
            c0-5.6,4.5-10.1,10.1-10.1C84.2,46.7,88.7,51.3,88.7,56.8z" />
    </g>
</svg>`;

                        

let orcidReemplazados = 0;

// La expresión regular, ahora sí completa, para que capture el párrafo entero.
const regexParaReemplazar = /<p[^>]*class="[^"]*(?:orcid|ORCID|adscripcion|ESTILOS-FINALES_orcid|ESTILOS-FINALES_ORCID)[^"]*"[^>]*>(?:(?!<\/p>).)*?<a[^>]*href="(?<link>https?:\/\/(?:www\.)?orcid\.org\/\d{4}-\d{4}-\d{4}-\d{4})\s*">(?:(?!<\/p>).)*?<\/p>/sig;
nuevoHtml = nuevoHtml.replace(regexParaReemplazar, (matchCompleto, ...args) => {
    orcidReemplazados++;
    const groups = args.pop();
    const linkCapturado = groups.link.trim();

    console.log(`ORCID Encontrado #${orcidReemplazados}: ${linkCapturado}`);

    const textoVector = `
<p class="ORCID2">
    <span class="_idSVGInline">${svgContent}</span>
    <a href="${linkCapturado}">
        <span class="Hiperv-nculo">${linkCapturado}</span>
    </a>
</p>`;
    return textoVector.trim();
});

if (orcidReemplazados === 0) {
    console.log("ADVERTENCIA: La expresión regular para ORCID no encontró ninguna coincidencia en el HTML.");
}
// --- TERMINA BLOQUE PARA REEMPLAZAR ---

                        const estilosParaTablas = `
                        /* Estilos para que las tablas ocupen todo el ancho */
                        table {
                            width: auto;
                            max-width: 100%;
                            border-collapse: collapse;
                            margin-top: 0;
                            margin-bottom: 0;
                            padding-left:0.5em;
                            padding-right:0.5em;
                            margin-left: auto;
                            margin-right: auto;
                        }
                        th, td {
                            border: 1px solid #ccc;
                            padding: 0.5em;
                            text-align: left;
                        }
                        `;
                        const bloqueCSS = `\n.contenedor{padding: 2em 3.5em 2em 3.5em;}\n
                            ${clasesVector}\n
                            ${estilosDatosAutor}\n
                            ${cssContenido}\n
                            ${estilosParaTablas}\n
                            </style>`;
                            
                        function pxToEm(match, pxValue) {
                            const emValue = parseInt(pxValue) / 9;
                            return `${emValue.toFixed(1)}em;`;
                        }

                        function aumentarMargen(match, direction, value, unit) {
                            const valorNumerico = parseFloat(value);
                            let resultado;
                            if (valorNumerico === 0) {
                                resultado = `margin-${direction}: 2em;`;
                            } else {
                                const nuevoValor = valorNumerico + 2;
                                resultado = `margin-${direction}: ${nuevoValor}${unit};`;
                            }
                            return resultado;
                        }


                        const cssModificado = bloqueCSS
                            .replace(/\s*(\d+)px;/g, pxToEm)
                            .replace(/margin-(top|bottom):\s*(\d+\.?\d*)(\w*);/g, aumentarMargen);

                        const bloqueDeEstiloFinal = `<style>\n${cssModificado}\n</style>`;

                        const linkRegex = /<link[^>]+href="(?:.\/)?estilos\.css"[^>]*>/i;

                        if (nuevoHtml.match(linkRegex)) {
                        nuevoHtml = nuevoHtml.replace(linkRegex, bloqueDeEstiloFinal);
                        } else {
                        nuevoHtml = nuevoHtml.replace(/(<\/head>)/i, `${bloqueDeEstiloFinal}\n$1`);
                        }

       

                        nuevoHtml = nuevoHtml.replace(/<body([^>]*)>/i, `<body$1>\n<div class='contenedor'>`);
                        nuevoHtml = nuevoHtml.replace(/<\/body>/i, `</div>\n</body>`);

                        const regexNotasAlPie = /(href=")[^#"]*(#[^"]*")/g;
                        nuevoHtml = nuevoHtml.replace(regexNotasAlPie,'$1$2');


                        
                        
                        nuevoHtml = nuevoHtml.replace(/ParaOverride-[2,1]/g,'');


                        // Guardar el resultado en variables globales para la descarga
                        archivoProcesado = nuevoHtml;
                        nombreArchivoProcesado =  `r${htmlFile.name}`;
                        tipoMimeProcesado = 'text/html';

                        // Actualizar la interfaz de usuario
                        botonProcesar.disabled = false;
                        botonProcesar.textContent = 'Procesar y convertir';
                        botonDescargar.classList.remove('hidden');
                        botonReiniciar.classList.remove('hidden');
                        botonSubirHtml.disabled = false;
                        botonSubirCss.disabled = false;

                    } catch (error) {
                        console.error("Error al procesar los archivos:", error);
                        console.log("Hubo un error al procesar los archivos. Por favor, asegúrate de haber subido los correctos. Detalles: " + error.message);
                        botonProcesar.disabled = false;
                        botonProcesar.textContent = 'Procesar y convertir';
                        botonSubirHtml.disabled = false;
                        botonSubirCss.disabled = false;
                    }
                })
                .catch(error => {
                    console.error("Error al leer los archivos:", error);
                    console.log("Hubo un error al leer los archivos. Por favor, asegúrate de haber subido los correctos. Detalles: " + error.message);
                    botonProcesar.disabled = false;
                    botonProcesar.textContent = 'Procesar y convertir';
                    botonSubirHtml.disabled = false;
                    botonSubirCss.disabled = false;
                });
        }

        // Función para descargar el archivo
        function descargarArchivo() {
            if (archivoProcesado) {
                const blob = new Blob([archivoProcesado], { type: tipoMimeProcesado });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = nombreArchivoProcesado;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } else {
                console.log("Primero debes subir y procesar un archivo.");
            }
        }

        // Función para reiniciar el estado de la aplicación
        function reiniciarAplicacion() {
            htmlFile = null;
            cssFile = null;
            archivoProcesado = null;
            nombreArchivoProcesado = null;
            tipoMimeProcesado = null;
            inputHtml.value = '';
            inputCss.value = '';
            actualizarEstadoUI();
            botonDescargar.classList.add('hidden');
        }

        // Lógica de escucha de eventos
        botonSubirHtml.addEventListener('click', () => {
            inputHtml.click();
        });
        
        botonSubirCss.addEventListener('click', () => {
            inputCss.click();
        });

        inputHtml.addEventListener('change', (event) => {
            htmlFile = event.target.files[0];
            actualizarEstadoUI();
        });

        inputCss.addEventListener('change', (event) => {
            cssFile = event.target.files[0];
            actualizarEstadoUI();
        });
        
        botonProcesar.addEventListener('click', () => {
            if (htmlFile && cssFile) {
                procesarArchivos(htmlFile, cssFile);
            } else {
                console.log("Faltan archivos por subir.");
            }
        });

        botonDescargar.addEventListener('click', descargarArchivo);
        botonReiniciar.addEventListener('click', reiniciarAplicacion);
    </script>

</body>
</html>
